FROM scratch

USER 65532:65532
COPY charts ./charts
COPY manifests ./manifests
COPY registry ./registry
ENV AUTH_NS=sealos
# ENV CASDOOR_HOST=$(kubectl get nodes -o jsonpath="{.items[0].status.addresses[0].address}")
ENV CASDOOR_HOST=locahost
ENV CASDOOR_PORT=30080
ENV CASDOOR_ENDPOINT=http://$CASDOOR_HOST:$CASDOOR_PORT
ENV CASDOOR_CALLBACK_URL=http://localhost:8080/login/callback
CMD [ "kubectl create namespace $AUTH_NS",
      "helm install casdoor ./charts/casdoor --namespace $AUTH_NS",
      "helm install service-auth ./charts/service-auth --namespace $AUTH_NS --set image.tag=dev --set config.callbackUrl=$CASDOOR_CALLBACK_URL --set config.ssoEndpoint=$CASDOOR_ENDPOINT",
      "kubectl apply -f manifests/"]
